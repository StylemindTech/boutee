---
// ./src/components/PortableTextImage.astro
import { urlForImage } from "../sanity/lib/url-for-image";
import { optimizeImageUrl } from "../lib/imageKit";

const { asset, alt, caption } = Astro.props.node;

const renderCaption = (value) => {
  if (typeof value === "string") {
    const text = value.trim();
    return text ? [<p class="m-0">{text}</p>] : null;
  }

  if (Array.isArray(value)) {
    const blocks = value.filter((block) => block?._type === "block");
    const hasText = blocks.some((block) =>
      Array.isArray(block.children) &&
      block.children.some((child) => typeof child?.text === "string" && child.text.trim())
    );
    if (!hasText) return null;

    return blocks.map((block, index) => (
      <p class="m-0" key={block?._key || `caption-${index}`}>
        {(block.children || []).map((child) => {
          let node = child?.text || "";
          if (child?.marks?.includes("strong")) node = <strong class="font-bold">{node}</strong>;
          if (child?.marks?.includes("em")) node = <em class="italic">{node}</em>;
          if (child?.marks?.includes("underline")) node = <u class="underline">{node}</u>;
          if (child?.marks?.includes("strike-through") || child?.marks?.includes("strike")) {
            node = <s>{node}</s>;
          }
          if (child?.marks?.includes("code")) node = <code class="bg-gray-100 px-1 rounded">{node}</code>;
          if (child?.marks?.length) {
            const def = (block.markDefs || []).find((d) => child.marks.includes(d._key));
            if (def?.href) {
              node = (
                <a href={def.href} class="underline text-textPrimary" target="_blank">
                  {node}
                </a>
              );
            }
          }
          return node;
        })}
      </p>
    ));
  }

  return null;
};

const captionContent = renderCaption(caption);
const hasCaption = Boolean(captionContent);

const url = optimizeImageUrl(urlForImage(asset).url(), 900, 70);
const webpUrl = optimizeImageUrl(urlForImage(asset).format("webp").url(), 900, 70);
---

<figure class="my-[24px]">
  <picture>
    <source srcset={webpUrl} type="image/webp" />
    <img
      class={`w-full lg:h-[589px] object-cover ${hasCaption ? "rounded-t-[24px] rounded-b-none" : "rounded-[24px]"}`}
      src={url}
      alt={alt}
    />
  </picture>
  {hasCaption && (
    <figcaption class="bg-[#F2F3F7] border border-[#E4E6EB] border-t-0 rounded-b-[24px] px-4 py-3 text-[14px] leading-[20px] text-textSecondary space-y-1">
      {captionContent}
    </figcaption>
  )}
</figure>
