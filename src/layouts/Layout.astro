---
import Navbar from "../components/common/Navbar.astro";
import Footer from "../components/common/Footer.astro";
import "aos/dist/aos.css";
import "../styles/global.css";
const { title = "Boutee - Home", description = "Find your perfect handcrafted ring by connecting directly with independent UK jewellers. Boutee helps you define your style, match with makers, and bring your ideas to life." } = Astro.props;
import { VisualEditing } from "@sanity/astro/visual-editing";

const visualEditingEnabled =
  import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED == "true";
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
const gaInlineScript = gaMeasurementId
  ? `window.dataLayer = window.dataLayer || [];
function gtag(){window.dataLayer.push(arguments);}
console.log('[GA] Initialising GA4 with ID', '${gaMeasurementId}');
gtag('js', new Date());
gtag('config', '${gaMeasurementId}', { debug_mode: true });`
  : null;

const fontHref = "https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/Logo.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" as="style" href={fontHref} />
    <link rel="stylesheet" href={fontHref} />
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-TQBT9XVS");
    </script>
    <!-- End Google Tag Manager -->
    {gaMeasurementId && (
      <>
        <script
          async
          src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}
        ></script>
        <script set:html={gaInlineScript}></script>
      </>
    )}
  </head>
  <body class="flex flex-col min-h-screen scroll-smooth">
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-TQBT9XVS"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    <!-- Header -->
    <Navbar />

    <!-- Page Content -->
    <main class="flex-1">
      <slot />
      <VisualEditing enabled={visualEditingEnabled} />
    </main>


    <!-- Footer -->
    <Footer />

    <!-- AOS init -->
    <script>
      import AOS from "aos";
      AOS.init({
        duration: 500, // ms
        once: false,
      });
    </script>
  </body>
</html>

<script>
const captureGclid = () => {
  if (typeof window === "undefined" || typeof document === "undefined") return;

  const params = new URLSearchParams(window.location.search);
  const gclid = params.get("gclid");
  if (!gclid) return;

  const ninetyDaysInSeconds = 90 * 24 * 60 * 60;
  const host = window.location.hostname;
  const cookieDomain =
    host === "boutee.co.uk" || host.endsWith(".boutee.co.uk")
      ? ".boutee.co.uk"
      : host;

  document.cookie = [
    `gclid=${encodeURIComponent(gclid)}`,
    "path=/",
    `domain=${cookieDomain}`,
    `max-age=${ninetyDaysInSeconds}`,
    "SameSite=Lax",
  ].join(";");
};

const getStoredGclid = () => {
  if (typeof document === "undefined") return null;
  const match = document.cookie.match(/(?:^|;\s*)gclid=([^;]+)/);
  return match ? decodeURIComponent(match[1]) : null;
};

if (typeof window !== "undefined") {
  window.goToApp = () => {
    const gclid = getStoredGclid();
    const base = "https://app.boutee.co.uk/";
    const url = gclid ? `${base}?gclid=${encodeURIComponent(gclid)}` : base;
    window.location.href = url;
  };
}

captureGclid();

document.addEventListener("DOMContentLoaded", () => {
  const initImageFade = () => {
    const process = (img) => {
      if (!img || img.dataset.fadeBound) return;
      img.dataset.fadeBound = "1";
      img.classList.add("img-fade");
      const markLoaded = () => img.classList.add("img-loaded");
      if (img.complete && img.naturalWidth > 0) {
        markLoaded();
      } else {
        img.addEventListener("load", markLoaded, { once: true });
        img.addEventListener("error", markLoaded, { once: true });
      }
    };

    const scan = (root = document) => {
      root.querySelectorAll("img").forEach(process);
    };

    scan();

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((m) => {
        m.addedNodes.forEach((node) => {
          if (node.nodeType !== 1) return;
          if (node.tagName === "IMG") {
            process(node);
          } else if (node.querySelectorAll) {
            scan(node);
          }
        });
      });
    });

    observer.observe(document.body, { childList: true, subtree: true });
  };

  // ðŸ”¹ Spin Button Icons
  const initSpinButtons = () => {
    const buttons = document.querySelectorAll(".spinBtn");

    buttons.forEach((btn) => {
      const icon = btn.querySelector(".btnIcon");
      if (!icon) return;

      btn.addEventListener("click", () => {
        icon.classList.remove("animate-spin-once");
        // Force reflow to restart animation
        void icon.offsetWidth;
        icon.classList.add("animate-spin-once");
      });
    });
  };

  // ðŸ”¹ Floating Parallax for Hero
  const initParallax = () => {
    let ticking = false;

    const updateParallax = () => {
      document.querySelectorAll(".floating").forEach((el) => {
        const speed = parseFloat(el.dataset.speed) || 0.3;
        const offset = window.scrollY * speed * -0.4;
        el.style.setProperty("--parallaxY", `${offset}px`);
      });
      ticking = false;
    };

    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(updateParallax);
        ticking = true;
      }
    });
  };

  // ðŸ”¹ Intersection Observer Animations
  const initIntersectionAnimations = () => {
    const target = document.querySelector(".wrapper");
    if (!target) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          target.classList.toggle("animate", entry.isIntersecting);
        });
      },
      { threshold: 0.3 }
    );

    observer.observe(target);
  };

  // Initialize all features
  initSpinButtons();
  initParallax();
  initIntersectionAnimations();
  initImageFade();
});
</script>

