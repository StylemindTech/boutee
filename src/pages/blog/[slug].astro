---
// ./src/pages/post/[slug].astro
import type { SanityDocument } from "@sanity/client";
import { loadQuery } from "../../sanity/lib/load-query";
import BaseLayout from "../../layouts/Layout.astro";
import { Image } from "astro:assets";
import rightShift from "../../assets/icons/right-shift.png";
import badge from "../../assets/icons/Badge-blog.svg";
import link from "../../assets/icons/Link.svg";
import linkedin from "../../assets/icons/Linkedin.svg";
import facebook from "../../assets/icons/Facebook.svg";
import twitter from "../../assets/icons/X.svg";
import arrow from "../../assets/icons/ArrowRight.svg";
import { urlForImage } from "../../sanity/lib/url-for-image";
import { optimizeImageUrl } from "../../lib/imageKit";

const blocksToPlainText = (blocks: any[]): string => {
  if (!Array.isArray(blocks)) return "";
  return blocks
    .filter((block) => block?._type === "block" && Array.isArray(block.children))
    .map((block) => block.children.map((child) => child?.text || "").join(""))
    .join("\n\n")
    .trim();
};

export async function getStaticPaths() {
  const { data: posts } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "post" && !(_id in path("drafts.**")) && !defined(*[_id == "drafts." + _id][0])]`,
  });

  return posts
    .filter((p) => p?.slug?.current)
    .map(({ slug }) => ({
      params: { slug: slug.current },
    }));
}

const { params } = Astro;

const { data: post } = await loadQuery({
    query: `*[_type == "post" && slug.current == $slug && !(_id in path("drafts.**")) && !defined(*[_id == "drafts." + _id][0])][0]{
  title,
  description,
  metaTitle,
  metaDescription,
  "ogImage": ogImage{ ..., "url": asset->url },
  slug,
  "author": author->{
    _id,
    name,
    image,
    profession,
    bio
  },
  "mainImage": mainImage{ ..., "url": asset->url },
  "categories": categories[]->{ _id, title },
  publishedAt,
  body
}`,
  params,
});

function formatDate(dateString: string) {
  if (!dateString) return "";
  return new Intl.DateTimeFormat("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  }).format(new Date(dateString));
}

const mainImageUrl = post?.mainImage ? optimizeImageUrl(urlForImage(post.mainImage).url(), 900, 70) : null;
const authorImageUrl = post?.author?.image ? optimizeImageUrl(urlForImage(post.author.image).url(), 200, 70) : null;
const resolvedAuthor = {
  name: post?.author?.name || "",
  role: post?.author?.profession || "",
  bio: blocksToPlainText(post?.author?.bio),
  photoSrc: authorImageUrl,
  photoAlt: post?.author?.image?.alt || post?.author?.name || "Blog author",
};
const pageTitle = post?.metaTitle || (post?.title ? `Boutee - ${post.title}` : "Boutee - Blog");
const pageDescription = post?.metaDescription || post?.description;

const { data: relatedPosts } = await loadQuery<SanityDocument[]>({
  query: `*[_type == "post" && !(_id in path("drafts.**")) && !defined(*[_id == "drafts." + _id][0]) && slug.current != $slug && count(categories[@._ref in $categoryIds]) > 0] 
    | order(publishedAt desc)[0...3]{
      title,
      slug,
      publishedAt,
      description,
      mainImage,
      "categories": categories[]->{ _id, title }
    }`,
  params: {
    slug: post?.slug?.current,
    categoryIds: post?.categories?.map((cat: any) => cat?._id) || [],
  },
});

const extractHeadings = (content) => {
  if (!content) return [];
  return content
    .filter(
      (block) =>
        block?._type === "block" &&
        (block?.style === "h1" || block?.style === "h2")
    )
    .map((block) => ({
      id: block?._key,
      text: block?.children?.map((child) => child?.text).join("") || "",
      level: block?.style === "h1" ? 1 : 2,
    }));
};

const toc = extractHeadings(post?.body || []);

const extractPlainTextFromContent = (content: any[]): string => {
  if (!Array.isArray(content)) return "";

  const segments: string[] = [];

  content.forEach((block) => {
    if (block?._type === "block" && Array.isArray(block.children)) {
      segments.push(block.children.map((child) => child?.text).join(" "));
    }

    if (block?._type === "tableBlock" && Array.isArray(block.rows)) {
      block.rows.forEach((row: any) => {
        row?.cells?.forEach((cell: any) => {
          if (Array.isArray(cell?.content)) {
            cell.content.forEach((cellBlock: any) => {
              if (
                cellBlock?._type === "block" &&
                Array.isArray(cellBlock.children)
              ) {
                segments.push(
                  cellBlock.children.map((child: any) => child?.text).join(" ")
                );
              }
            });
          }
        });
      });
    }

    if (block?._type === "table" && Array.isArray(block.rows)) {
      block.rows.forEach((row: any) => {
        row?.cells?.forEach((cell: any) => {
          if (typeof cell === "string") {
            segments.push(cell);
          } else if (
            cell?._type === "block" &&
            Array.isArray(cell?.children)
          ) {
            segments.push(cell.children.map((child: any) => child?.text).join(" "));
          }
        });
      });
    }
  });

  return segments.join(" ");
};

function calculateReadTime(content: any[]): string {
  if (!content || content.length === 0) return "1 min read";

  const text = extractPlainTextFromContent(content).trim();
  if (!text) return "1 min read";

  const words = text.trim().split(/\s+/).length;
  const wordsPerMinute = 200;
  const minutes = Math.ceil(words / wordsPerMinute);

  return `${minutes} min read`;
}
---

<BaseLayout title={post?.metaTitle || "Boutee Blog"}
description={post?.metaDescription || post?.summary}
ogImage={post?.ogImage ? urlForImage(post.ogImage) : urlForImage(post?.mainImage)}>
  {
    post ? (
      <>
        {/* <!-- Post Header --> */}
        <section class="md:pt-[112px] md:pb-[32px] pt-[24px]">
          <div class="max-w-screen-2xl lg:px-20 px-[24px] mx-auto pb-[8px]">
            <div class="flex flex-col lg:flex-row lg:gap-10 xl:gap-20 gap-6 md:gap-8">
              <div class="flex flex-col justify-between mb-[24px] md:mb-[32px] lg:mb-0 order-2 lg:order-1">
                <div class="pb-[20px] md:pb-[24px] mb-[24px] md:mb-[20px]">
                  <div class="mb-[20px] md:mb-[24px] flex justify-start items-center gap-1">
                    <a
                      href="/blog"
                      class="font-figtree font-normal text-[16px] leading-[20px] text-textSecondary"
                    >
                      Blog
                    </a>
                    <Image src={rightShift} class="h-3 w-3" alt="arrow" />
                    {post?.categories && (
                      <span class="font-figtree font-normal text-[16px] leading-[20px] text-textSecondary capitalize">
                        {post.categories.map((cat) => cat?.title).join(", ")}
                      </span>
                    )}
                  </div>
                  <h1 class="font-ppradio font-black text-textPrimary text-[32px] leading-[36px] md:text-[52px] md:leading-[56px]">
                    {post?.title}
                  </h1>
                </div>

                <div class="flex flex-col gap-3 md:gap-4">
                  {resolvedAuthor?.name && (
                    <>
                      <div class="flex items-center gap-3">
                        {resolvedAuthor.photoSrc && (
                          <img
                            src={resolvedAuthor.photoSrc}
                            alt={resolvedAuthor.photoAlt}
                            class="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover"
                            loading="lazy"
                          />
                        )}
                        <div class="flex flex-col leading-tight">
                          <span class="font-figtree text-[12px] leading-[14px] uppercase tracking-[0.08em] text-textSecondary">
                            Written by
                          </span>
                          <span class="font-figtree font-semibold text-[16px] leading-[20px] text-textPrimary">
                            {resolvedAuthor.name}
                          </span>
                        </div>
                      </div>
                      <div class="flex items-center gap-[12px] text-textSecondary">
                        <span class="font-figtree font-normal text-sm leading-[18px]">
                          {formatDate(post?.publishedAt)}
                        </span>
                        <Image src={badge} alt="dot" class="h-2 w-2" />
                        <span class="font-figtree font-normal text-sm leading-[18px]">
                          {calculateReadTime(post?.body)}
                        </span>
                      </div>
                    </>
                  )}

                  <div>
                    <p class="font-figtree font-normal text-[16px] leading-[20px] text-textPrimary mb-[12px]">
                      Share this post
                    </p>
                    <div class="flex items-center gap-2">
                      <a
                        href="#"
                        class="h-9 w-9 rounded-[12px] p-2 bg-cardColor"
                      >
                        <Image src={link} alt="link" class="h-5 w-5" />
                      </a>
                      <a
                        href="#"
                        class="h-9 w-9 rounded-[12px] p-2 bg-cardColor"
                      >
                        <Image src={facebook} alt="fb" class="h-5 w-5" />
                      </a>
                      <a
                        href="#"
                        class="h-9 w-9 rounded-[12px] p-2 bg-cardColor"
                      >
                        <Image src={linkedin} alt="linkedin" class="h-5 w-5" />
                      </a>
                      <a
                        href="#"
                        class="h-9 w-9 rounded-[12px] p-2 bg-cardColor"
                      >
                        <Image src={twitter} alt="twitter" class="h-5 w-5" />
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              {mainImageUrl && (
                <img
                  src={mainImageUrl}
                  alt={post?.mainImage?.alt || "blog image"}
                  class="rounded-[24px] w-full max-w-[600px] aspect-square object-cover order-1 lg:order-2 lg:w-[450px] lg:h-[380px] xl:w-[600px] xl:h-[425px]"
                />
              )}
            </div>
          </div>
        </section>

        {/* <!-- Blog Content --> */}
        <section class="md:py-[40px] lg:py-[80px] pt-[16px] pb-[48px]">
          <div class="max-w-screen-2xl lg:px-20 px-[24px] mx-auto">
            <div class="flex flex-col justify-between lg:flex-row gap-10 lg:gap-20 xl:gap-[120px]">
              {/* <!-- Mobile TOC --> */}
              {toc?.length > 0 && (
                <div id="mobile-toc" class="lg:hidden flex flex-col w-full bg-[#F2F3F7] rounded-[12px] px-3 py-2">
                  <div id="mobile-toc-toggle" class="cursor-pointer flex items-center justify-between gap-3 w-full min-h-[44px]">
                    <span class="font-ppradio font-black text-[16px] leading-[20px] text-textPrimary flex items-center">
                      Skip to:
                    </span>
                    <svg class="mobile-toc-chevron w-4 h-4 mt-1 transition-transform duration-200 ease-in-out" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M6 9l6 6 6-6" />
                    </svg>
                  </div>
                  <div id="mobile-toc-options" class="flex flex-col gap-1 overflow-hidden" style="max-height: 0; transition: max-height 200ms ease-in-out;">
                    {toc.map((heading) => (
                      <button
                        type="button"
                        data-mobile-toc-option
                        data-id={heading?.id}
                        data-text={heading?.text}
                        class="w-full text-left px-1 py-2 font-figtree text-[16px] leading-[20px] text-textPrimary transition-colors duration-150 active:bg-[#e4e6eb]"
                        style="white-space: normal;"
                      >
                        {heading?.text}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* <!-- Blog Content --> */}
              <div
                class="blog_content__list flex flex-col font-figtree
    [&>ul]:custom-counter-list
    [&>ul]:counter-reset-li-counter
    [&>ul>li]:relative
    [&>ul>li]:mb-3
    [&>ul>li]:pl-[40px]
    [&>ul>li]:font-normal
    [&>ul>li]:text-base
    [&>ul>li]:text-textPrimary
    [&>ul>li]:before:absolute
    [&>ul>li]:before:left-0
    [&>ul>li]:before:top-0
    [&>ul>li]:before:flex
    [&>ul>li]:before:items-center
    [&>ul>li]:before:justify-center
    [&>ul>li]:before:h-[28px]
    [&>ul>li]:before:w-[28px]
    [&>ul>li]:before:rounded-[40px]
    [&>ul>li]:before:bg-[linear-gradient(189.75deg,#F2F3F7_-1.71%,#EDEAEF_100.1%)]
    [&>ul>li]:before:content-[counter(li-counter)]
    [&>ul>li]:before:counter-increment-li-counter
    [&>blockquote]:py-3 [&>blockquote]:px-4 [&>blockquote]:bg-secondary [&>blockquote]:border [&>blockquote]:border-[#F2F3F7] [&>blockquote]:rounded-[16px] [&>blockquote]:italic [&>blockquote]:font-figtree [&>blockquote]:font-medium [&>blockquote]:text-[16px] [&>blockquote]:lg:text-[18px] [&>blockquote]:lg:leading-[22px] [&>blockquote]:leading-[20px] [&>blockquote]:text-textSecondary
    [&>h1]:mb-[24px] [&>h1]:text-[28px] [&>h1]:lg:text-[40px] [&>h1]:font-ppradio [&>h1]:text-textPrimary [&>h1]:leading-[32px] [&>h1]:lg:leading-[44px]
    [&>h2]:mb-[24px] [&>h2]:text-[22px] [&>h2]:lg:text-[32px] [&>h2]:font-ppradio [&>h2]:text-textPrimary [&>h2]:leading-[28px] [&>h2]:lg:leading-[40px]
    [&>h3]:mb-[24px] [&>h3]:text-[20px] [&>h3]:lg:text-[28px] [&>h3]:font-ppradio [&>h3]:text-textPrimary [&>h3]:leading-[24px] [&>h3]:lg:leading-[36px]
    [&>h4]:mb-[24px] [&>h4]:text-[18px] [&>h4]:lg:text-[24px] [&>h4]:font-ppradio [&>h4]:text-textPrimary [&>h4]:leading-[20px] [&>h4]:lg:leading-[32px]
    [&>p]:mb-[16px] [&>p]:text-[16px] [&>p]:lg:text-[18px]
    [&>table]:w-full [&>table]:border-collapse [&>table]:border-spacing-0 [&>table]:my-[24px] [&>table]:text-left [&>table]:text-textPrimary
    [&>table>tbody>tr>td]:align-top [&>table>tbody>tr>td]:py-[12px] [&>table>tbody>tr>td]:pr-[24px] [&>table>tbody>tr>td:last-child]:pr-0 [&>table>tbody>tr>td]:text-[16px] [&>table>tbody>tr>td]:lg:text-[18px] [&>table>tbody>tr>td]:leading-[20px] [&>table>tbody>tr>td]:lg:leading-[22px] [&>table>tbody>tr>td]:font-normal [&>table>tbody>tr>td]:text-textPrimary [&>table>tbody>tr>td]:bg-transparent [&>table>tbody>tr>td]:border-0"
              >
                {(() => {
                  // ✅ Render inline marks (bold, italic, code, link)
                  const renderChildren = (children, markDefs = []) =>
                    children.map((c) => {
                      let node = c.text;

                      if (c.marks?.includes("strong")) {
                        node = <strong class="font-bold">{node}</strong>;
                      }
                      if (c.marks?.includes("em")) {
                        node = <em class="italic">{node}</em>;
                      }
                      if (c.marks?.includes("underline")) {
                        node = <u class="underline">{node}</u>;
                      }
                      if (c.marks?.includes("strike-through") || c.marks?.includes("strike")) {
                        node = <s>{node}</s>;
                      }
                      if (c.marks?.includes("code")) {
                        node = (
                          <code class="bg-gray-100 px-1 rounded">{node}</code>
                        );
                      }
                      if (c.marks?.length) {
                        const def = markDefs.find((d) =>
                          c.marks.includes(d._key)
                        );
                        if (def?.href) {
                          node = (
                            <a
                              href={def.href}
                              class="underline text-textPrimary"
                              target="_blank"
                            >
                              {node}
                            </a>
                          );
                        }
                      }
                      return node;
                    });

                  const renderTableCell = (cell) => {
                    // Plugin (@sanity/table) shape: cell is a string
                    if (typeof cell === "string") {
                      return <p class="text-textPrimary text-[16px] lg:text-[18px] leading-[20px] lg:leading-[22px] mb-0">{cell}</p>;
                    }

                    // Custom shape with content blocks
                    if (Array.isArray(cell?.content)) {
                      return (
                        <div class="space-y-2">
                          {cell.content
                            .filter((child) => child?._type === "block")
                            .map((child) => (
                              <p
                                class="text-textPrimary text-[16px] lg:text-[18px] leading-[20px] lg:leading-[22px] mb-0"
                                key={child?._key}
                              >
                                {renderChildren(child.children || [], child.markDefs || [])}
                              </p>
                            ))}
                        </div>
                      );
                    }

                    // Fallback: try a text property or children
                    if (typeof cell === "object" && cell) {
                      const text =
                        (Array.isArray(cell.children)
                          ? cell.children.map((c) => c?.text || "").join(" ")
                          : cell.text) || "";
                      return text ? (
                        <p class="text-textPrimary text-[16px] lg:text-[18px] leading-[20px] lg:leading-[22px] mb-0">
                          {text}
                        </p>
                      ) : null;
                    }

                    return null;
                  };

                  // ✅ Group blocks into lists
                  const elements = [];
                  let currentList = null;

                  post?.body?.forEach((block) => {
                    if (block._type === "block" && block.listItem) {
                      // Inside a list
                      if (
                        !currentList ||
                        currentList.style !== block.listItem
                      ) {
                        if (currentList) {
                          elements.push(currentList.el);
                        }
                        currentList = {
                          style: block.listItem,
                          items: [],
                          el: null,
                        };
                      }
                      currentList.items.push(
                        <li key={block._key}>
                          {renderChildren(block.children, block.markDefs)}
                        </li>
                      );
                    } else {
                      // Close list if switching back to normal content
                      if (currentList) {
                        currentList.el =
                          currentList.style === "bullet" ? (
                            <ul key={block._key}>{currentList.items}</ul>
                          ) : (
                            <ol key={block._key}>{currentList.items}</ol>
                          );
                        elements.push(currentList.el);
                        currentList = null;
                      }

                      // ✅ Normal content blocks
                      if (block._type === "block") {
                        const content = renderChildren(
                          block.children,
                          block.markDefs
                        );

                        if (block.style === "h1")
                          elements.push(<h1 id={block._key}>{content}</h1>);
                        else if (block.style === "h2")
                          elements.push(<h2 id={block._key}>{content}</h2>);
                        else if (block.style === "h3")
                          elements.push(<h3 id={block._key}>{content}</h3>);
                        else if (block.style === "h4")
                          elements.push(<h4 id={block._key}>{content}</h4>);
                        else if (block.style === "blockquote")
                          elements.push(<blockquote>{content}</blockquote>);
                        else elements.push(<p>{content}</p>);
                      }

                      // ✅ Image blocks
                      if (block._type === "image" && block.asset?._ref) {
                        const url = optimizeImageUrl(urlForImage(block).url(), 900, 70);
                        elements.push(
                          <figure class="my-[24px]">
                            <img
                              src={url}
                              alt={block.alt || "Blog image"}
                              class="rounded-[24px] w-full h-auto object-cover"
                            />
                            {block.caption && (
                              <figcaption>{block.caption}</figcaption>
                            )}
                          </figure>
                        );
                      }

                      if (block._type === "tableBlock" || block._type === "table") {
                        const rows = Array.isArray(block.rows) ? block.rows : [];
                        elements.push(
                          <table class="blog-table" key={block._key || `table-${elements.length}`}>
                            <tbody>
                              {rows.map((row, rowIndex) => (
                                <tr key={row?._key || `row-${rowIndex}`}>
                                  {(row?.cells || []).map((cell, cellIndex) => (
                                    <td key={cell?._key || `cell-${rowIndex}-${cellIndex}`}>
                                      {renderTableCell(cell)}
                                    </td>
                                  ))}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        );
                      }

                      if (block._type === "divider") {
                        elements.push(
                          <hr
                            key={block._key || `divider-${elements.length}`}
                            class="w-full border-0 border-t border-[#E4E6EB] my-4"
                          />
                        );
                      }

                      // ✅ Code blocks
                      if (block._type === "code") {
                        elements.push(
                          <pre class="bg-gray-900 text-white p-4 rounded-lg overflow-x-auto">
                            <code>{block.code}</code>
                          </pre>
                        );
                      }
                    }
                  });

                  // ✅ Close last list if still open
                  if (currentList) {
                    currentList.el =
                      currentList.style === "bullet" ? (
                        <ul key="last">{currentList.items}</ul>
                      ) : (
                        <ol key="last">{currentList.items}</ol>
                      );
                    elements.push(currentList.el);
                  }

                  return elements;
                })()}
              </div>

              {/* <!-- Desktop TOC --> */}
              {toc?.length > 0 && (
                <div class="hidden lg:block sticky top-16 h-fit md:max-h-[300px] lg:max-h-[400px]  xl:max-h-[450px] overflow-y-auto min-w-fit pr-2">
                  <h5 class="mb-[24px] font-figtree font-bold text-[20px] leading-[24px] text-textPrimary">
                    Table of contents
                  </h5>
                  <ul id="toc-list">
                    {toc.map((heading) => (
                      <li
                        class="mb-[8px] flex px-3 py-2 gap-2 items-center hover:bg-cardColor text-textSecondary hover:text-textPrimary rounded-[12px] cursor-pointer min-w-[320px]"
                        data-id={heading.id}
                      >
                        <Image src={arrow} class="h-5 w-5" alt="arrow" />
                        <span class="font-figtree text-[16px]">
                          {heading.text}
                        </span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* <!-- Author --> */}
            {resolvedAuthor?.name && (
              <div class="mt-8 md:mt-12 max-w-4xl">
                <div class="flex flex-col sm:flex-row items-start gap-4 sm:gap-6 bg-[#F2F3F7] border border-[#E4E6EB] rounded-[16px] p-4 md:p-6">
                  {resolvedAuthor.photoSrc && (
                    <img
                      src={resolvedAuthor.photoSrc}
                      alt={resolvedAuthor.photoAlt}
                      class="w-16 h-16 sm:w-[72px] sm:h-[72px] md:w-20 md:h-20 rounded-full object-cover flex-shrink-0"
                      loading="lazy"
                    />
                  )}
                  <div class="space-y-2">
                    <div class="space-y-1">
                      <p class="font-figtree text-[12px] leading-[14px] uppercase tracking-[0.08em] text-textSecondary">
                        About the author
                      </p>
                      <h3 class="font-figtree font-semibold text-textPrimary text-lg leading-[24px]">
                        {resolvedAuthor.name}
                      </h3>
                      {resolvedAuthor?.role && (
                        <p class="font-figtree text-sm text-textSecondary">
                          {resolvedAuthor.role}
                        </p>
                      )}
                    </div>
                    {resolvedAuthor?.bio && (
                      <p class="font-figtree text-[16px] leading-[22px] text-textPrimary">
                        {resolvedAuthor.bio}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        </section>

        {/* <!-- Related posts --> */}
        {relatedPosts?.length > 0 && (
          <section class="lg:py-[112px] py-[48px]">
            <div class="max-w-screen-2xl lg:px-20 px-[24px] mx-auto">
              <div class="lg:mb-[80px] mb-[24px]">
                <div class="flex justify-between items-center w-full">
                  <h2 class="lg:text-[52px] text-center md:text-start w-full text-[32px] lg:leading-[56px] leading-[36px] font-black font-ppradio text-textPrimary">
                    Related posts
                  </h2>
                  <a
                    href="/blog"
                    class="hidden sm:flex font-figtree font-medium text-base w-[104px] leading-5 text-textPrimary bg-cardColor h-12 rounded-[16px] justify-center items-center cursor-pointer"
                  >
                    View all
                  </a>
                </div>
              </div>

              <div class="grid sm:grid-cols-2 lg:grid-cols-3 lg:gap-[40px] gap-[20px]">
                {relatedPosts.map(
                  (rp) =>
                    rp?.slug?.current && (
                      <div class="min-w-[240px] rounded-[20px] border border-cardColor flex flex-col">
                        <a href={`/blog/${rp.slug.current}`}>
                          <img
                            src={optimizeImageUrl(urlForImage(rp.mainImage).url(), 600, 70)}
                            alt={rp?.mainImage?.alt || "blog image"}
                            class="rounded-[24px] mb-[8px] w-full aspect-square object-cover"
                          />
                        </a>
                        <div class="p-[12px] lg:py-4 lg:px-5">
                          {rp?.categories && (
                            <span class="inline-block grid uppercase place-content-center h-[22px] py-1 px-3 rounded-[40px] bg-cardColor md:bg-[#E3E4E8] font-figtree text-[10px] text-textPrimary">
                              {rp.categories
                                .map((cat) => cat?.title)
                                .join(", ")}
                            </span>
                          )}
                          <a href={`/blog/${rp.slug.current}`}>
                            <h3 class="mt-[12px] mb-[8px] font-figtree font-bold text-textPrimary text-lg lg:text-[20px]">
                              {rp?.title}
                            </h3>
                          </a>
                          <p class="line-clamp-2 mb-[16px] lg:mb-[32px] font-figtree text-base text-textPrimary">
                            {rp?.description}
                          </p>
                          <div class="w-full flex items-center gap-2">
                            <span class="font-figtree text-sm text-textSecondary">
                              {formatDate(rp?.publishedAt)}
                            </span>
                            <Image src={badge} alt="dot" class="h-2 w-2" />
                            <span class="font-figtree text-sm text-textSecondary">
                              {/* fallback since relatedPosts has no body */}
                              {calculateReadTime(post?.body || [])}
                            </span>
                          </div>
                        </div>
                      </div>
                    )
                )}
              </div>

              <button class="mt-[24px] w-full sm:hidden font-figtree font-medium text-base text-textPrimary bg-cardColor h-12 rounded-[16px] cursor-pointer">
                View all
              </button>
            </div>
          </section>
        )}
      </>
    ) : (
      <p class="text-center py-20 font-figtree text-lg text-textSecondary">
        Post not found.
      </p>
    )
  }
  <script type="module">
    window.addEventListener("DOMContentLoaded", () => {
      const headings = document.querySelectorAll(
        ".blog_content__list h1, .blog_content__list h2"
      );
      const tocItems = document.querySelectorAll("ul li[data-id]");
      const mobileToc = document.getElementById("mobile-toc");
      const mobileTocToggle = document.getElementById("mobile-toc-toggle");
      const mobileTocButtons = document.querySelectorAll("[data-mobile-toc-option]");
      const mobileChevron = document.querySelector(".mobile-toc-chevron");
      const mobileTocOptions = document.getElementById("mobile-toc-options");
      let mobileTocOpen = false;
      const mobileOptionsById = {};
      mobileTocButtons.forEach((btn) => {
        mobileOptionsById[btn.dataset.id] = btn.dataset.text;
      });

      function clearActive() {
        tocItems.forEach((li) =>
          li.classList.remove("text-textPrimary", "bg-cardColor")
        );
      }

      function onScroll() {
        let currentId = "";
        headings.forEach((heading) => {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 120) currentId = heading.id;
        });
        if (!currentId) return;
        clearActive();
        const activeItem = document.querySelector(
          `ul li[data-id="${currentId}"]`
        );
        if (activeItem) {
          activeItem.classList.add("text-textPrimary", "bg-cardColor");
        }
      }

      window.addEventListener("scroll", onScroll);

      tocItems.forEach((li) => {
        li.addEventListener("click", (e) => {
          e.preventDefault();
          const id = li.getAttribute("data-id");
          const heading = document.getElementById(id);
          if (heading)
            heading.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });

      const closeMobileToc = () => {
        setMobileTocOpen(false);
      };

      const syncChevron = () => {
        if (!mobileChevron) return;
        if (mobileTocOpen) {
          mobileChevron.classList.add("rotate-180");
        } else {
          mobileChevron.classList.remove("rotate-180");
        }
        if (mobileTocOptions) {
          if (mobileTocOpen) {
            mobileTocOptions.style.maxHeight = `${mobileTocOptions.scrollHeight}px`;
          } else {
            mobileTocOptions.style.maxHeight = "0px";
          }
        }
      };

      const setMobileTocOpen = (open) => {
        mobileTocOpen = open;
        if (mobileToc) {
          mobileToc.dataset.open = open ? "true" : "false";
        }
        syncChevron();
      };

      syncChevron();

      mobileTocToggle?.addEventListener("click", (e) => {
        e.preventDefault();
        setMobileTocOpen(!mobileTocOpen);
      });

      mobileTocButtons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const id = btn.dataset.id;
          const heading = document.getElementById(id);
          if (heading) {
            heading.scrollIntoView({ behavior: "smooth", block: "start" });
          }
          closeMobileToc();
          syncChevron();
        });
      });
    });
  </script>
</BaseLayout>
